<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–µ–Ω—Ç–∞ | Chel-Love</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --text: #ffffff; --card: rgba(255, 255, 255, 0.05); --border: rgba(255, 255, 255, 0.1); }
        body.light-mode { --bg: #f1f5f9; --text: #0f172a; --card: #ffffff; --border: rgba(0,0,0,0.1); }
        body { background: var(--bg); color: var(--text); transition: 0.3s; padding-bottom: 100px; }
        .glass { background: var(--card); backdrop-filter: blur(10px); border: 1px solid var(--border); }
        .fab { background: #2563eb; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4); }
        .skeleton { background: linear-gradient(90deg, var(--card) 25%, var(--border) 50%, var(--card) 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="overflow-x-hidden">
    <header class="p-4 flex justify-between items-center glass sticky top-0 z-50">
        <a href="index.html" class="text-sm font-bold opacity-70">‚Üê –ù–ê–ó–ê–î</a>
        <div class="text-blue-500 font-black text-lg tracking-tighter">CHEL<span class="text-white ml-1 opacity-50 uppercase">Live</span></div>
        <button onclick="toggleTheme()" class="p-2 rounded-full glass" id="themeBtn">üåô</button>
    </header>

    <main id="feed" class="max-w-xl mx-auto p-4 space-y-6 mt-4">
        <div id="loader"><div class="glass rounded-[2rem] h-[400px] skeleton mb-6"></div><div class="glass rounded-[2rem] h-[400px] skeleton"></div></div>
    </main>

    <button id="mainActionBtn" onclick="openModal()" class="fixed bottom-6 left-1/2 -translate-x-1/2 fab text-white px-8 py-4 rounded-2xl font-bold z-40 flex items-center gap-2 active:scale-95 transition">
        <span>üìù</span> –ú–û–Ø –ê–ù–ö–ï–¢–ê
    </button>

    <div id="m" class="hidden fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-slate-900 p-6 rounded-[2.5rem] w-full max-w-sm border border-white/10 my-auto">
            <h2 class="text-xl font-bold mb-6 text-blue-400 text-center">–í–∞—à–∞ –∞–Ω–∫–µ—Ç–∞</h2>
            <div class="space-y-4">
                <input type="text" id="postName" placeholder="–ò–º—è" class="w-full bg-white/5 p-4 rounded-2xl outline-none border border-white/10 text-white text-sm">
                <input type="number" id="age" placeholder="–í–æ–∑—Ä–∞—Å—Ç" class="w-full bg-white/5 p-4 rounded-2xl outline-none border border-white/10 text-white text-sm">
                <label class="block">
                    <span class="text-[10px] text-gray-500 ml-2 uppercase tracking-widest">–§–æ—Ç–æ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ (–º–∞–∫—Å 500–∫–±)</span>
                    <input type="file" id="photoFile" accept="image/*" class="w-full bg-white/5 p-3 rounded-2xl border border-white/10 text-white text-xs mt-1">
                </label>
                <input type="text" id="tg" placeholder="Telegram (–±–µ–∑ @)" class="w-full bg-white/5 p-4 rounded-2xl outline-none border border-white/10 text-white text-sm">
                <textarea id="bio" placeholder="–û —Å–µ–±–µ..." class="w-full bg-white/5 p-4 rounded-2xl outline-none border border-white/10 text-white h-24 text-sm"></textarea>
            </div>
            <button id="sendBtn" class="w-full fab text-white py-4 rounded-2xl font-bold mt-6">–°–û–•–†–ê–ù–ò–¢–¨</button>
            <button onclick="document.getElementById('m').classList.add('hidden')" class="w-full mt-4 text-gray-500 text-sm">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, increment } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCTIwDY2Kjzeo5c3X7gyy89mOhHs0RlJyw",
            authDomain: "chel-love.firebaseapp.com",
            databaseURL: "https://chel-love-default-rtdb.firebaseio.com",
            projectId: "chel-love",
            appId: "1:334954303228:web:1d523948b0d3b0e8f25179"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));

        window.toggleTheme = () => {
            const isLight = document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            document.getElementById('themeBtn').innerText = isLight ? '‚òÄÔ∏è' : 'üåô';
        };

        window.like = async (ownerId) => {
            if(!currentUser) return alert("–í–æ–π–¥–∏!");
            const likedKey = `liked_${ownerId}_by_${currentUser.user}`;
            if(localStorage.getItem(likedKey)) return alert("–í—ã —É–∂–µ –ª–∞–π–∫–Ω—É–ª–∏!");
            
            await update(ref(db, 'posts/' + ownerId), { likes: increment(1) });
            localStorage.setItem(likedKey, true);
        };

        onValue(ref(db, 'posts'), (snapshot) => {
            const data = snapshot.val();
            const feed = document.getElementById('feed');
            if (!data) return feed.innerHTML = "<div class='text-center opacity-30 mt-10'>–ü–æ–∫–∞ –ø—É—Å—Ç–æ...</div>";
            
            const posts = Object.values(data).sort((a, b) => (b.likes || 0) - (a.likes || 0));
            feed.innerHTML = posts.map(p => `
                <div class="glass rounded-[2.5rem] overflow-hidden shadow-xl animate__animated animate__fadeIn">
                    <div class="relative">
                        <img src="${p.photo || 'https://via.placeholder.com/500'}" class="w-full h-[450px] object-cover" onerror="this.src='https://via.placeholder.com/500?text=–û—à–∏–±–∫–∞+—Ñ–æ—Ç–æ'">
                        <button onclick="like('${p.owner}')" class="absolute bottom-4 right-4 bg-black/40 backdrop-blur-md text-white px-5 py-2 rounded-full font-bold flex items-center gap-2 border border-white/20 active:scale-125 transition">
                            ‚ù§Ô∏è <span>${p.likes || 0}</span>
                        </button>
                    </div>
                    <div class="p-6">
                        <h3 class="text-2xl font-bold">${p.name}, ${p.age}</h3>
                        <p class="text-gray-400 my-3 text-sm leading-relaxed">${p.text}</p>
                        <a href="https://t.me/${p.contact}" target="_blank" class="block w-full fab text-white py-4 rounded-2xl font-bold text-center active:opacity-70">–ù–ê–ü–ò–°–ê–¢–¨</a>
                    </div>
                </div>
            `).join('');
        });

        window.openModal = async () => {
            if(!currentUser) return alert("–í–æ–π–¥–∏!");
            const snap = await get(ref(db, 'posts/' + currentUser.user));
            if(snap.exists()){
                const d = snap.val();
                document.getElementById('postName').value = d.name || '';
                document.getElementById('age').value = d.age || '';
                document.getElementById('tg').value = d.contact || '';
                document.getElementById('bio').value = d.text || '';
            }
            document.getElementById('m').classList.remove('hidden');
        };

        document.getElementById('sendBtn').onclick = async () => {
            const btn = document.getElementById('sendBtn');
            const file = document.getElementById('photoFile').files[0];
            const name = document.getElementById('postName').value.trim();
            const age = document.getElementById('age').value;
            const tg = document.getElementById('tg').value.trim().replace('@', '');
            const bio = document.getElementById('bio').value.trim();

            if(!name || !age || !tg) return alert("–ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ!");

            btn.disabled = true; btn.innerText = "–ó–ê–ì–†–£–ó–ö–ê...";

            let photoBase64 = "";
            if(file) {
                if(file.size > 600000) { alert("–°–ª–∏—à–∫–æ–º —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ç–æ! –í—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–µ."); btn.disabled = false; return; }
                photoBase64 = await new Promise(res => {
                    const r = new FileReader(); r.readAsDataURL(file); r.onload = () => res(r.result);
                });
            }

            const postRef = ref(db, 'posts/' + currentUser.user);
            const oldSnap = await get(postRef);
            const oldData = oldSnap.exists() ? oldSnap.val() : { likes: 0 };

            await set(postRef, {
                name, age, contact: tg, text: bio, owner: currentUser.user,
                photo: photoBase64 || oldData.photo || "",
                likes: oldData.likes || 0
            });

            btn.disabled = false; btn.innerText = "–°–û–•–†–ê–ù–ò–¢–¨";
            document.getElementById('m').classList.add('hidden');
        };

        if (localStorage.getItem('theme') === 'light') { document.body.classList.add('light-mode'); document.getElementById('themeBtn').innerText = '‚òÄÔ∏è'; }
    </script>
</body>
</html>
